#' Remove all artifacts generated by scripts
#'
#' Removes all output files generated by scripts in the pipeline, including
#' intermediate files and the incremental build cache. This provides a complete 
#' clean of generated artifacts. The pipeline can be regenerated by running run() again.
#'
#' @return Character vector of file paths that were actually removed
#' @export
#' @examples
#' \dontrun{
#' # Remove all generated files
#' removed_files <- clean()
#' }
clean <- function() {
  # Parse all scripts to get dependencies
  dependencies <- bakepipe:::parse()

  # If no scripts found, just try to remove cache and return
  if (length(dependencies) == 0) {
    state_file <- file.path(root(), ".bakepipe.state")
    if (file.exists(state_file) && file.remove(state_file)) {
      return(state_file)
    } else {
      return(character(0))
    }
  }

  # Collect all outputs
  all_outputs <- character(0)

  for (script_info in dependencies) {
    all_outputs <- c(all_outputs, script_info$outputs)
  }

  # Remove duplicates
  all_outputs <- unique(all_outputs)

  # Add state file to files to remove
  state_file <- file.path(root(), ".bakepipe.state")
  files_to_check <- c(all_outputs, state_file)

  # Only try to remove files that actually exist
  existing_files <- files_to_check[file.exists(files_to_check)]

  # Remove the files
  removed_files <- character(0)
  for (file_path in existing_files) {
    if (file.remove(file_path)) {
      removed_files <- c(removed_files, file_path)
    }
  }

  removed_files
}